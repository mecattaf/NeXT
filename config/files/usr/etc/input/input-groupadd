#!/bin/bash

LOGFILE="/tmp/input-groupadd.log"

{
    echo "Script started at $(date)"

    # Determine the intended user from /etc/passwd
    target_user=$(awk -F: '$3>=1000 && $3<65534 {print $1; exit}' /etc/passwd)
    echo "Target user: $target_user"

    # Exit if no valid user is found
    if [ -z "$target_user" ]; then
        echo "No valid non-root user found."
        exit 1
    fi

    # Create the input group if it does not exist
    if ! getent group input > /dev/null; then
        groupadd -r input
        if [ $? -ne 0 ]; then
            echo "Failed to create group 'input'."
            exit 1
        else
            echo "Group 'input' created successfully."
        fi
    else
        echo "Group 'input' already exists."
    fi

    # Add the determined user to the input group if not already a member
    if ! id -nG "$target_user" | grep -qw "input"; then
        usermod -aG input "$target_user"
        if [ $? -ne 0 ]; then
            echo "Failed to add user '$target_user' to group 'input'."
            exit 1
        else
            echo "User '$target_user' added to group 'input' successfully."
        fi
    else
        echo "User '$target_user' is already a member of group 'input'."
    fi

    echo "Script finished at $(date)"
} >> $LOGFILE 2>&1
